<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Happy Birthday Tiá»ƒu My</title>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

<style>
body{
 margin:0;
 overflow:hidden;
 background:#020205;
 font-family:'Segoe UI',sans-serif;
}

#canvas-container{width:100vw;height:100vh;}

#instruction{
 position:fixed;
 top:15px; left:20px;
 color:#FFD700;
 font-size:14px;
 line-height:1.6;
 z-index:10010;
 text-shadow:0 0 6px rgba(255,215,0,.6);
}

#camera-wrapper{
 position:absolute;
 bottom:20px; left:20px;
 width:160px; height:120px;
 z-index:10002;
 pointer-events:none;
}

#camera-preview{
 width:100%; height:100%;
 border:2px solid #FFD700;
 border-radius:6px;
 transform:scaleX(-1);
 opacity:.9;
}

#loading-bar{
 position:absolute;
 bottom:0; left:0;
 height:4px;
 width:0%;
 background:#FFD700;
}

#celebration-video{
 position:fixed;
 inset:0;
 width:100%; height:100%;
 object-fit:contain;
 display:none;
 z-index:9999;
}

#close-area{
 position:fixed;
 top:0; right:0;
 width:100px; height:100px;
 display:none;
 z-index:10001;
 cursor:pointer;
}

#close-icon{
 position:absolute;
 top:20px; right:20px;
 font-size:22px;
 color:white;
}
</style>
</head>

<body>

<div id="instruction">
âœ‹ 1 â†’ 5 : Hiá»ƒn thá»‹ sá»‘<br>
ðŸŽ‰ 0 : Báº¤T NGá»œ<br>
</div>

<video id="celebration-video" muted loop>
 <source src="video.mp4" type="video/mp4">
</video>

<div id="close-area"><div id="close-icon">âœ–</div></div>

<div id="camera-wrapper">
 <canvas id="camera-preview"></canvas>
 <div id="loading-bar"></div>
</div>

<video id="input-video" style="display:none"></video>
<div id="canvas-container"></div>

<script type="importmap">
{
 "imports":{
  "three":"https://unpkg.com/three@0.160.0/build/three.module.js",
  "three/addons/":"https://unpkg.com/three@0.160.0/examples/jsm/"
 }
}
</script>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

/* ================= CONFIG ================= */
const CONFIG={
 particleSize:2.6,
 imageGap:1.7,
 morphSpeed:0.18,
 HOLD_DURATION:800
};

let scene,camera,renderer,controls,particles;
let particleTargets=null;
let photoPositions=null;
let numberCache={};
let birthdayTargets=null;

let currentMode='PHOTO';
let holdStart=0;
let isVideo=false;

/* ================= THREE INIT ================= */
scene=new THREE.Scene();
scene.background=new THREE.Color(0x020205);

camera=new THREE.PerspectiveCamera(50,innerWidth/innerHeight,1,5000);
camera.position.z=900;

renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
document.getElementById('canvas-container').appendChild(renderer.domElement);

controls=new OrbitControls(camera,renderer.domElement);
controls.enableDamping=true;

/* ================= CAKE CANVAS ================= */
function createCakeCanvas(){
 const c=document.createElement('canvas');
 c.width=500; c.height=500;
 const ctx=c.getContext('2d');

 ctx.fillStyle='black';
 ctx.fillRect(0,0,500,500);

 // Cake layers
 ctx.fillStyle='#FFD700';
 ctx.fillRect(120,300,260,80);
 ctx.fillRect(160,240,180,70);

 // Candle
 ctx.fillStyle='#FFFFFF';
 ctx.fillRect(245,190,10,50);

 const flame=ctx.createRadialGradient(250,170,2,250,170,18);
 flame.addColorStop(0,'#FFFFFF');
 flame.addColorStop(0.4,'#FFD700');
 flame.addColorStop(1,'rgba(255,69,0,0)');
 ctx.fillStyle=flame;
 ctx.beginPath();
 ctx.arc(250,170,18,0,Math.PI*2);
 ctx.fill();

 // Stars
 for(let i=0;i<300;i++){
  ctx.fillStyle='white';
  ctx.fillRect(Math.random()*500,Math.random()*500,2,2);
 }

 return c;
}

/* ================= PARTICLES ================= */
function canvasToParticles(canvas){
 const ctx=canvas.getContext('2d');
 const d=ctx.getImageData(0,0,canvas.width,canvas.height).data;
 const pts=[];
 for(let i=0;i<d.length;i+=4){
  if(d[i+3]>10){
   pts.push(
    (i/4)%canvas.width-canvas.width/2,
    -(Math.floor(i/4/canvas.width)-canvas.height/2),
    (Math.random()-0.5)*40
   );
  }
 }
 const geo=new THREE.BufferGeometry();
 geo.setAttribute('position',new THREE.Float32BufferAttribute(pts,3));

 particles=new THREE.Points(
  geo,
  new THREE.PointsMaterial({
   color:0xFFD700,
   size:CONFIG.particleSize,
   transparent:true,
   blending:THREE.AdditiveBlending
  })
 );

 scene.add(particles);
 photoPositions=geo.attributes.position.array.slice();
 particleTargets=photoPositions;
}

/* ================= TEXT TARGET ================= */
function createBirthdayTargets(total){
 const c=document.createElement('canvas');
 c.width=1000; c.height=400;
 const ctx=c.getContext('2d');

 ctx.fillStyle='black';
 ctx.fillRect(0,0,1000,400);
 ctx.fillStyle='white';
 ctx.textAlign='center';

 ctx.font='bold 90px Arial';
 ctx.fillText("18/01",500,140);
 ctx.font='bold 60px Arial';
 ctx.fillText("HAPPY BIRTHDAY",500,230);
 ctx.fillText("NGÃ” TIá»‚U MY",500,310);

 return scanCanvas(c,total);
}

function scanCanvas(c,total){
 const ctx=c.getContext('2d');
 const d=ctx.getImageData(0,0,c.width,c.height).data;
 const pts=[];
 for(let i=0;i<d.length;i+=4){
  if(d[i]>128){
   pts.push(
    (i/4)%c.width-c.width/2,
    -(Math.floor(i/4/c.width)-c.height/2),
    (Math.random()-0.5)*80
   );
  }
 }
 const arr=new Float32Array(total*3);
 for(let i=0;i<total;i++){
  const p=pts[i%pts.length];
  arr[i*3]=p[0];
  arr[i*3+1]=p[1];
  arr[i*3+2]=p[2];
 }
 return arr;
}

/* ================= NUMBERS ================= */
function generateNumbers(total){
 for(let n=1;n<=5;n++){
  const c=document.createElement('canvas');
  c.width=200; c.height=200;
  const ctx=c.getContext('2d');
  ctx.fillStyle='black';
  ctx.fillRect(0,0,200,200);
  ctx.fillStyle='white';
  ctx.font='bold 160px Arial';
  ctx.textAlign='center';
  ctx.textBaseline='middle';
  ctx.fillText(n,100,100);
  numberCache[n]=scanCanvas(c,total);
 }
}

/* ================= HAND TRACKING ================= */
const video=document.getElementById('input-video');
const camCanvas=document.getElementById('camera-preview');
const camCtx=camCanvas.getContext('2d');
const loading=document.getElementById('loading-bar');

function onResults(res){
 camCtx.clearRect(0,0,camCanvas.width,camCanvas.height);
 camCtx.drawImage(res.image,0,0,camCanvas.width,camCanvas.height);

 let hands=[];
 if(res.multiHandLandmarks){
  for(const lm of res.multiHandLandmarks){
   let fingers=0;
   const tips=[8,12,16,20];
   const pips=[6,10,14,18];
   tips.forEach((t,i)=>{ if(lm[t].y<lm[pips[i]].y) fingers++; });
   if(Math.abs(lm[4].x-lm[17].x)>Math.abs(lm[3].x-lm[17].x)) fingers++;
   hands.push(fingers);
  }
 }
 updateState(hands);
}

function updateState(hands){
 if(hands.length>=2 && hands.filter(f=>f<=1).length>=2){
  if(!holdStart) holdStart=Date.now();
  const e=Date.now()-holdStart;
  loading.style.width=Math.min(e/CONFIG.HOLD_DURATION*100,100)+'%';
  if(e>=CONFIG.HOLD_DURATION){
   playVideo();
   holdStart=0;
  }
  return;
 }

 loading.style.width='0%';
 holdStart=0;

 if(hands.length){
  const f=hands[0];
  if(f>=1 && f<=5){
   particleTargets=numberCache[f];
  }else if(f===0){
   particleTargets=birthdayTargets;
  }else{
   particleTargets=photoPositions;
  }
 }else{
  particleTargets=photoPositions;
 }
}

/* ================= VIDEO ================= */
const celeb=document.getElementById('celebration-video');
const close=document.getElementById('close-area');

function playVideo(){
 isVideo=true;
 celeb.style.display='block';
 close.style.display='block';
 celeb.play();
}

close.onclick=()=>{
 isVideo=false;
 celeb.pause();
 celeb.style.display='none';
 close.style.display='none';
};

/* ================= LOOP ================= */
function animate(){
 requestAnimationFrame(animate);

 if(particles && particleTargets){
  const pos=particles.geometry.attributes.position.array;
  for(let i=0;i<pos.length;i++){
   pos[i]+=(particleTargets[i]-pos[i])*CONFIG.morphSpeed;
  }
  particles.geometry.attributes.position.needsUpdate=true;
 }

 controls.update();
 renderer.render(scene,camera);
}

/* ================= START ================= */
canvasToParticles(createCakeCanvas());
generateNumbers(particles.geometry.attributes.position.count);
birthdayTargets=createBirthdayTargets(particles.geometry.attributes.position.count);

const hands=new Hands({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
hands.setOptions({maxNumHands:2,minDetectionConfidence:.5,minTrackingConfidence:.5});
hands.onResults(onResults);

const cam=new Camera(video,{
 onFrame:async()=>{await hands.send({image:video});},
 width:320,height:240
});
cam.start();

animate();
</script>
</body>
</html>
