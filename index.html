<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Birthday Interactive Cake</title>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

<style>
body{margin:0;overflow:hidden;background:#020205}
#camera-preview{
 position:fixed;bottom:20px;left:20px;
 width:180px;height:140px;
 border:2px solid gold;z-index:10;
 transform:scaleX(-1);
}
</style>
</head>

<body>
<canvas id="camera-preview" width="180" height="140"></canvas>
<video id="input-video" autoplay playsinline style="display:none"></video>

<script type="importmap">
{
 "imports":{
  "three":"https://unpkg.com/three@0.160.0/build/three.module.js"
 }
}
</script>

<script type="module">
import * as THREE from 'three';

/* ===== THREE SETUP ===== */
const scene=new THREE.Scene();
scene.background=new THREE.Color(0x020205);

const camera=new THREE.PerspectiveCamera(55,innerWidth/innerHeight,1,5000);
camera.position.z=1000;

const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
document.body.appendChild(renderer.domElement);

/* ===== CAKE GROUP ===== */
const cakeGroup=new THREE.Group();
scene.add(cakeGroup);

/* ===== CAKE PARTICLES ===== */
let cakeParticles, candleParticles, fireworks=[];
let candleOn=true;

function createCake(){
 const pts=[], cols=[];
 const add=(x,y,z,c)=>{
  pts.push(x,y,z);
  cols.push(c.r,c.g,c.b);
 };

 for(let x=-200;x<200;x+=6)
  for(let y=-60;y<20;y+=6)
   add(x,y,(Math.random()-0.5)*50,new THREE.Color('#FFD27F'));

 for(let x=-140;x<140;x+=6)
  for(let y=30;y<90;y+=6)
   add(x,y,(Math.random()-0.5)*40,new THREE.Color('#FFF0A0'));

 const geo=new THREE.BufferGeometry();
 geo.setAttribute('position',new THREE.Float32BufferAttribute(pts,3));
 geo.setAttribute('color',new THREE.Float32BufferAttribute(cols,3));

 cakeParticles=new THREE.Points(
  geo,
  new THREE.PointsMaterial({size:3,vertexColors:true})
 );
 cakeGroup.add(cakeParticles);
}

function createCandle(){
 const pts=[], cols=[];
 for(let y=100;y<190;y+=5){
  pts.push(0,y,(Math.random()-0.5)*10);
  cols.push(1,1,1);
 }
 const geo=new THREE.BufferGeometry();
 geo.setAttribute('position',new THREE.Float32BufferAttribute(pts,3));
 geo.setAttribute('color',new THREE.Float32BufferAttribute(cols,3));
 candleParticles=new THREE.Points(
  geo,
  new THREE.PointsMaterial({size:4,vertexColors:true})
 );
 cakeGroup.add(candleParticles);
}

function explodeFirework(){
 const pts=[], cols=[];
 for(let i=0;i<400;i++){
  pts.push(0,160,0);
  const c=new THREE.Color().setHSL(Math.random(),1,0.6);
  cols.push(c.r,c.g,c.b);
 }
 const geo=new THREE.BufferGeometry();
 geo.setAttribute('position',new THREE.Float32BufferAttribute(pts,3));
 geo.setAttribute('color',new THREE.Float32BufferAttribute(cols,3));
 const fw=new THREE.Points(
  geo,
  new THREE.PointsMaterial({size:4,vertexColors:true,transparent:true})
 );
 fw.vel=[];
 for(let i=0;i<pts.length;i+=3){
  fw.vel.push(
   (Math.random()-0.5)*20,
   Math.random()*20,
   (Math.random()-0.5)*20
  );
 }
 fireworks.push(fw);
 scene.add(fw);
}

createCake();
createCandle();

/* ===== HAND TRACK ===== */
const video=document.getElementById('input-video');
const canvas=document.getElementById('camera-preview');
const ctx=canvas.getContext('2d');

let blowCounter=0;

function onResults(res){
 ctx.clearRect(0,0,180,140);
 ctx.drawImage(res.image,0,0,180,140);

 if(!res.multiHandLandmarks) return;
 const lm=res.multiHandLandmarks[0];

 let fingers=0;
 const tips=[8,12,16,20], pips=[6,10,14,18];
 tips.forEach((t,i)=>{ if(lm[t].y<lm[pips[i]].y) fingers++; });

 if(fingers===5 && candleOn){
  blowCounter++;
  if(blowCounter>12){
   candleOn=false;
   cakeGroup.remove(candleParticles);
   explodeFirework();
  }
 } else blowCounter=0;
}

const hands=new Hands({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
hands.setOptions({maxNumHands:1});
hands.onResults(onResults);

const cam=new Camera(video,{
 onFrame:async()=>await hands.send({image:video}),
 width:640,height:480
});
cam.start();

/* ===== ANIMATE ===== */
function animate(){
 requestAnimationFrame(animate);

 cakeGroup.rotation.y+=0.002;

 if(candleOn && candleParticles){
  candleParticles.position.y=160+Math.sin(Date.now()*0.01)*2;
 }

 fireworks.forEach((fw,i)=>{
  const p=fw.geometry.attributes.position.array;
  for(let j=0;j<p.length;j+=3){
   p[j]+=fw.vel[j/3*3];
   p[j+1]+=fw.vel[j/3*3+1]-0.5;
   p[j+2]+=fw.vel[j/3*3+2];
  }
  fw.material.opacity-=0.01;
  fw.geometry.attributes.position.needsUpdate=true;
 });

 renderer.render(scene,camera);
}
animate();
</script>
</body>
</html>
